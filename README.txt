#################################################################################################
#################################################################################################
README file for tree code with block time step on GPU(s) written by Yohei MIKI
                                                         last updated on 2017/03/16 (Thu) 19:56:05
#################################################################################################
#################################################################################################

GOTHIC and MAGI are released under the MIT license.
See LICENSE.txt for detail.


#################################################################################################
GOTHIC: Gravitational Oct-Tree code accelerated by HIerarchical time step Controlling
MAGI: MAny-component Galaxy Initializer
#################################################################################################


#################################################################################################
#################################################################################################
files contained in the zipped file
#################################################################################################
Makefile
README (this file)
#################################################################################################
#################################################################################################


#################################################################################################
#################################################################################################
directories contained in the zipped file
#################################################################################################
cfg:	parameter sets to describe initial conditions generated by MAGI: "MAny-component Galaxy Initializer"
host:	hostfiles for MVAPICH2
plt:	gp files for GNUPLOT
sh:	shell scripts
src:	source files
	src/file:	I/O subroutines
	src/init:	initial condition generator; includes MAGI: "MAny-component Galaxy Initializer"
	src/main:	source files including main
	src/misc:	common functions (definitions of structures and so on)
	src/para:	OpenMP and/or MPI subroutines
	src/plot:	plot subroutines
	src/sort:	sort subroutines (includes key generator of space filling curve)
	src/time:	time integration
	src/tree:	make tree structure, build LET, and walk tree
#################################################################################################
#################################################################################################


#################################################################################################
#################################################################################################
locations of common files (not included in this package)
#################################################################################################
$(MYDIR) in Makefile specifies the locations
$(MYDIR)/inc: location of original headers
$(MYDIR)/lib: location of original libraries
$(MYDIR)/inc/common.mk: describes system configuration and locations of installed software
#################################################################################################
#################################################################################################


#################################################################################################
#################################################################################################
commands defined in Makefile
#################################################################################################
dir:	create directories (bench, bin, dat, doc, fig, log)
init:	compile initial condition generators
    		requires GSL, libSPmyutil.a, libSPconstants.a, libSPmpilib.a, libSPompmpilib.a, libSPtimer.a, libSPtimer.a
		optionally requires Silo, HDF5, Szip
magi:	compile MAGI: "MAny-component Galaxy Initializer"
       		requires GSL, libSPmyutil.a, libSPconstants.a, libSPompmpilib.a, libSPtimer.a, libSPtimer.a
	 	optionally requires Silo, HDF5, Szip
calc:	compile tree code
       		requires libSPmyutil.a, libSPconstants.a, libSPtimer.a, libSPcudalib.a
		optionally requires Silo, HDF5, Szip
plot:	compile plot code
       		requires PLplot, libSPmyutil.a, libSPconstants.a, libSPmpilib.a, libSPplplotlib.a
		optionally requires Silo, HDF5, Szip
zip:	create zipped file, zipped file is moved in pub/
clean:	remove executable files and object files
#################################################################################################
#################################################################################################


#################################################################################################
#################################################################################################
directories created by $ make dir
#################################################################################################
bench:	results of benchmark
bin:	executable files
dat:	snapshot, dump files
doc:	physical properties of initial condition, unit system
fig:	figures
log:	log files
#################################################################################################
#################################################################################################


#################################################################################################
#################################################################################################
Overall options defined in Makefile
#################################################################################################
USEDBG:	 1 activates gdb and cuda-gdb; default is 0
USEDP:	 0 is single precision mode (real is float), 1 is double precision mode (real is double); default is 0 (1 is not implemented)
MKOPREP: 1 generates optimization report by intel compiler for C codes; 0 is default
USEPAPI: 1 activates PAPI (Performance Programming Application Interface) for C codes; 0 is default
VERBOSE: @ suppresses the log of the compilation; null is default
#################################################################################################
#################################################################################################
Macros for Pre-Processor
#################################################################################################
DEBUG:		ON suppresses function calls and so on, OFF is for debugging; default is ON
PROFILE:	ON activates gprof; OFF is default
#################################################################################################
#################################################################################################
Unit system of the simulation: activate one of listed options
#################################################################################################
UNIT	:= -DUNITSYSTEM="UnityValueSystem"
UNIT	:= -DUNITSYSTEM="GalacticScale"
UNIT	:= -DUNITSYSTEM="GalacticNucleiScale"
UNIT	:= -DUNITSYSTEM="StellarScale"
UNIT	:= -DUNITSYSTEM="UnityNewton"
UNIT	:= -DUNITSYSTEM="HostGalaxyScale"
#################################################################################################
#################################################################################################
# Execution options
#################################################################################################
FORCE_SINGLE_GPU_RUN:	1 enforces single-GPU execution, 0 enables multi-GPU execution; 1 is default (tests of multi-GPU mode have not yet been completed)
CONSTRUCT_LET_ON_GPU:	1 generates LET on GPU, 0 generates LET on CPU; 0 is default (LET generator on GPU is not yet implemented)
ADOPT_BLOCK_TIME_STEP:	1 enables block time step, 0 uses shared time step; 1 is default
IJ_PARALLELIZED_WALK:	1 activates ij-parallelized tree walk, 0 is i-parallelized tree walk; 1 is default
COMPARE_REBUILD_TIMING:	1 adds power-law growth model, and parabolic growth model of execution time to linear growth model used in 0;= 1 is default
GENERATE_PHKEY_ON_GPU:	1 generates PH-key and sort particles on GPU, while 0 does on CPU; 1 is default
CALC_MULTIPOLE_ON_GPU:	1 calculates multipole moments on GPU, while 0 does on CPU; 1 is default
LOCALIZE_I_PARTICLES:	1 limits the separation of PH-key of i-particles contained in a group, while 0 allows any jump of PH-key; 1 is default
SNAPSHOT_FORMAT_SILO:	1 use Silo format to read/write snapshot; 1 is default (Szip, HDF5, Silo libraries must be installed)
#################################################################################################
#################################################################################################
# Initial condition option
#################################################################################################
USE_POLAR_COORDINATE:	1 adopts spherical coordinate system to generate potential-density pair of the disk component; 1 is default (0 is a discarded option)
#################################################################################################
#################################################################################################
# Debugging options
#################################################################################################
EVALUATE_FORCE_ERROR:	1 compares acceleration and potential calculated by direct-sum and tree method; 0 is default
DEBUG_TREE_TRAVERSAL:	1 prints useful information to debug calculation of gravity based on tree method; 0 is default
DEBUG_MULTIPOLE_GPU:	1 prints useful information to debug calculation of multipole moments on GPU; 0 is default
#################################################################################################
#################################################################################################
# Benchmark options
#################################################################################################
MEASURE_ELAPSED_TIME:	1 reports elapsed time of representative functions in every step; 0 is default
MEASURE_EXEC_METRICS:	1 reports # of interactions in every step (necessary to estimate Flops); 0 is default
HUNT_OPTIMAL_WALK_TREE:	1 allows putting parameter sets related to tree traversal from Makefile; 0 is default
HUNT_OPTIMAL_MAKE_TREE:	1 allows putting parameter sets related to tree construction from Makefile; 0 is default
HUNT_OPTIMAL_MAKE_NODE:	1 allows putting parameter sets related to calculate multipole moments from Makefile; 0 is default
HUNT_OPTIMAL_INTEGRATE:	1 allows putting parameter sets related to time integration from Makefile; 0 is default
MEASURE_NI_DEPENDENCE:	1 reports elapsed time of tree walk as a function of Ni; 0 is default
#################################################################################################
#################################################################################################


#################################################################################################
#################################################################################################
some additional notes related to tree walk
#################################################################################################
real is float (only the single precision can be compiled)
#################################################################################################
# Macros in src/tree/walk_dev.cu
READ_ONLY_CACHE_AVAILABLE:		enabled (automatically enabled for GPUs of CC = 2.0)
USE_WARP_SHUFFLE_FUNC:			enabled (automatically enabled for GPUs of CC = 2.0)
INDIVIDUAL_GRAVITATIONAL_SOFTENING:	disabled
IJ_PARALLELIZATION:			enabled
ACCURATE_ACCUMULATION:			enabled
PARTIAL_SUM_ACCELERATION:		enabled
ACCURATE_PARTIAL_SUM:			disabled (too slow if this option is enabled)
DBG_TREE_WALK:				disabled (activated by DEBUG_TREE_TRAVERSAL in Makefile)
COUNT_INTERACTIONS:			disabled (activated by MEASURE_EXEC_METRICS in Makefile)
#################################################################################################
NTHREADS;	# of threads per block, set to be 512
TSUB:		# of threads that share the group of i-particles, set to be 32
NWARP:		# of threads that share the same i-particle, set to be 2
NLOOP:		parameter to determine the length of local interaction list, set to be 1
#################################################################################################
#################################################################################################




note:
if you receive error message without any prescription, then try smaller value for TREE_SAFETY_VAL defined in src/tree/make.h



future update plans:
GOTHIC:
	confirmation of shared time step (leap-frog)
	MPI parallelization
MAGI:
	use cubic spline fitting when read table of density profile as input for Eddington formula
	input Sigma(R) for the spherical components; switching rotation axis for disk components
	rotation of spherical components (in arbitrary rotation axis)
	parallelization of random number generator for rejection method
	parallelization of BiCGSTAB (update of preconditioner)






下記のオプションについては，常時 ON になっているべきものなので，ソースコードからはこのフラグを消してしまう．
消し終わったら，Makefile からも該当する分岐を削除する．


下記のオプションについては，常時 OFF になっているべきものなので，ソースコードからはこのフラグを消してしまう．
消し終わったら，Makefile からも該当する分岐を削除する．



Doxygen 化については，anal, plot, main/showOptConfig.c は後回し．

tree/icom_dev.cu は作成中のコードなので，とりあえず放置．






enclosing ball のうち，どれを選ぶかというフラグがかなりややこしいので，整理するべき．
